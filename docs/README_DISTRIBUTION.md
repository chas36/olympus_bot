# Система распределения кодов олимпиады

## Обзор

Система поддерживает два варианта работы с кодами для всех классов (5-11):

### Вариант 1: Предварительное распределение (скрипт)
Коды распределяются заранее между всеми учениками по списку

### Вариант 2: Выдача по запросу (через бота)
Коды выдаются ученикам по мере их запроса в боте

---

## Особенности для 8 класса

Для 8 классов действует специальное правило:
- Каждому ученику назначается персональный код из пула 8 класса
- **Дополнительно** каждому 8 классу (8А, 8Б, 8В и т.д.) выделяются резервные коды из нераспределённых кодов 9 класса
- Резервные коды НЕ персонализированы и находятся в общем пуле класса
- Любой ученик класса может запросить резервный код

---

## Вариант 1: Предварительное распределение

### Использование скрипта

```bash
# Базовое использование
python scripts/distribute_codes.py --session-id <ID_СЕССИИ>

# С указанием директории для экспорта
python scripts/distribute_codes.py --session-id 1 --output-dir my_exports/

# Только распределить, без экспорта файлов
python scripts/distribute_codes.py --session-id 1 --skip-export
```

### Что делает скрипт:

1. **Распределяет коды** между всеми учениками классов 5-11
   - Для каждого класса берутся коды соответствующего класса
   - Коды распределяются равномерно по списку учеников
   - Каждому ученику назначается один персональный код

2. **Для 8 класса**: создаёт резервные коды
   - Берёт нераспределённые коды 9 класса
   - Распределяет их между параллелями 8 класса (8А, 8Б и т.д.)
   - Количество резервных кодов = количество учеников в параллели

3. **Генерирует Excel файлы** для каждого класса/параллели
   - Имя файла: `<класс><параллель>.xlsx` (например: `8А.xlsx`, `11И.xlsx`)
   - Содержит таблицу: ФИО - Код олимпиады
   - Для 8 классов: дополнительный лист "Резервные коды"

### Структура файлов:

```
exports/
├── 5А.xlsx
├── 5Б.xlsx
├── ...
├── 8А.xlsx           # Основные коды 8А
├── 8Б.xlsx           # Основные коды 8Б
├── ...
├── 11И.xlsx
└── ...
```

### Содержимое файла для 8 класса:

**Лист 1: Основные коды**
| ФИО | Код |
|-----|-----|
| Иванов Иван | CODE001 |
| Петрова Анна | CODE002 |

**Лист 2: Резервные коды (из пула 9 класса)**
| № | Код из 9 класса |
|---|----------------|
| 1 | CODE9_001 |
| 2 | CODE9_002 |

---

## Вариант 2: Выдача по запросу через бота

### Как это работает:

1. **Ученик регистрируется** в боте с помощью регистрационного кода
2. **Администратор активирует** сессию олимпиады через веб-интерфейс или бота
3. **Ученик запрашивает код** через команду `/olympiad` или кнопку в меню
4. **Система выдаёт код**:
   - Для 5-7, 9-11 классов: код из соответствующего пула
   - Для 8 класса:
     - Если есть предварительно назначенный код (Вариант 1) → выдаётся он
     - Если нет → выдаётся свободный код из пула 8 класса
     - Если основные коды закончились → выдаётся резервный код из пула 9 класса

### Логика выдачи для 8 класса:

```
1. Проверить: есть ли предварительно назначенный код (is_assigned)?
   ├── Да → Выдать этот код
   └── Нет → Продолжить

2. Проверить: есть ли свободные коды 8 класса?
   ├── Да → Выдать свободный код
   └── Нет → Продолжить

3. Проверить: есть ли резервные коды 9 класса для этой параллели?
   ├── Да → Выдать резервный код
   └── Нет → Сообщить, что коды закончились
```

---

## База данных

### Таблицы:

**`olympiad_codes`** - универсальная таблица кодов для 5-11 классов
- `class_number` - класс (5-11)
- `code` - код олимпиады
- `is_assigned` - распределён скриптом (Вариант 1)
- `student_id` - кому назначен (если is_assigned=true)
- `is_issued` - выдан через бота (Вариант 2)

**`grade8_reserve_codes`** - резервные коды 9 класса для 8 классов
- `class_parallel` - параллель 8 класса ("8А", "8Б" и т.д.)
- `code` - код из пула 9 класса
- `is_used` - использован ли код
- `used_by_student_id` - кто использовал

---

## Веб-интерфейс

### Управление сессиями:
1. Перейти на http://localhost:8001
2. Вкладка "Коды"
3. Загрузить CSV файлы с кодами
4. Запустить скрипт распределения (если нужен Вариант 1)
5. Активировать сессию для работы через бота (Вариант 2)

### Мониторинг:
- **Дашборд**: общая статистика по классам и кодам
- **Статистика**: сколько кодов выдано, осталось
- **Экспорт**: скачать списки учеников с кодами

---

## Примеры использования

### Сценарий 1: Предварительное распределение для всех классов

```bash
# 1. Загрузить коды через веб-интерфейс (CSV файлы)

# 2. Запустить скрипт распределения
python scripts/distribute_codes.py --session-id 1

# 3. Получить файлы в директории exports/
# 4. Распечатать и раздать ученикам
```

### Сценарий 2: Выдача по запросу через бота

```bash
# 1. Загрузить коды через веб-интерфейс
# 2. Активировать сессию
# 3. Ученики запрашивают коды через бота
```

### Сценарий 3: Комбинированный (для 8 класса)

```bash
# 1. Загрузить коды
# 2. Запустить скрипт (создаются персональные + резервные коды)
# 3. Раздать основные коды ученикам
# 4. Активировать сессию в боте
# 5. Если ученику нужен дополнительный код → он запрашивает через бота
#    → система выдаёт резервный код из пула
```

---

## API Endpoints

### Распределение кодов:
- `POST /api/codes/distribute/{session_id}` - запустить распределение
- `GET /api/codes/distribution-status/{session_id}` - статус распределения

### Экспорт:
- `GET /api/students/export/codes/{class_number}` - экспорт кодов класса
- `GET /api/students/export/reserve-codes/{class_parallel}` - резервные коды 8 класса

### Статистика:
- `GET /api/admin/statistics/overview` - общая статистика
- `GET /api/admin/statistics/class/{class_number}` - статистика класса

---

## Troubleshooting

### Проблема: Недостаточно кодов для класса
**Решение**: Загрузите дополнительные коды через веб-интерфейс

### Проблема: Для 8 класса нет резервных кодов
**Решение**: Убедитесь, что есть нераспределённые коды 9 класса

### Проблема: Скрипт не находит учеников
**Решение**: Убедитесь, что ученики загружены и у них указан `class_number`

### Проблема: Коды не выдаются через бота
**Решение**: Проверьте, что сессия активирована (`is_active=true`)

---

## Контакты

По вопросам работы системы обращаться к администратору.
