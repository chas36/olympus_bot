##  Универсальная система кодов для 5-11 классов

## Обзор

Система теперь поддерживает работу с учениками всех классов (5-11), заменяя старую систему, которая работала только с 8-9 классами.

### Два режима работы:

**Вариант 1: Предварительное распределение (скрипт)**
- Коды автоматически распределяются между учениками
- Генерируются файлы Excel для каждого класса
- Коды закрепляются за конкретными учениками

**Вариант 2: Выдача по запросу (через бота)**
- Ученики запрашивают коды через Telegram бота
- Коды выдаются из доступного пула
- Динамическое распределение в момент запроса

### Специальная логика для 8 класса:

- Получают свои основные коды (как все классы)
- Дополнительно получают резервные коды из пула 9 класса
- Резервные коды не персонализированы (общий пул класса)
- Количество резервных кодов = количеству учеников в классе

---

## 📋 Миграция базы данных

### Шаг 1: Применить SQL миграцию

```bash
# Сделайте backup текущей базы
pg_dump -U postgres olympus_bot > backup_$(date +%Y%m%d).sql

# Примените миграцию
psql -U postgres olympus_bot < migration_to_universal_codes.sql
```

### Что делает миграция:

1. ✅ Создает таблицу `olympiad_codes` для универсальных кодов (5-11 классы)
2. ✅ Создает таблицу `grade8_reserve_codes` для резервных кодов 8 класса
3. ✅ Мигрирует данные из старых таблиц `grade8_codes` и `grade9_codes`
4. ✅ Добавляет индексы для быстрого поиска
5. ✅ Выводит статистику после миграции

### Шаг 2: Обновить Python модели

Добавьте в `database/models.py`:

```python
# В конец файла добавить
from database.new_models import OlympiadCode, Grade8ReserveCode

# В класс Student добавить relationships:
assigned_codes = relationship("OlympiadCode", back_populates="student")
used_reserve_codes = relationship("Grade8ReserveCode", back_populates="used_by")

# В класс OlympiadSession добавить relationships:
universal_codes = relationship("OlympiadCode", back_populates="session", cascade="all, delete-orphan")
grade8_reserve_codes = relationship("Grade8ReserveCode", back_populates="session", cascade="all, delete-orphan")
```

---

## 🚀 Использование

### Вариант 1: Скрипт распределения кодов

#### Базовое использование:

```bash
# Распределить коды для сессии с ID=1
python scripts/distribute_codes.py --session-id 1

# С указанием директории для экспорта
python scripts/distribute_codes.py --session-id 1 --output-dir my_exports/

# Только распределение, без экспорта файлов
python scripts/distribute_codes.py --session-id 1 --skip-export
```

#### Что делает скрипт:

1. **Распределение кодов**:
   - Для каждого класса (5-11) берет доступные коды этого класса
   - Равномерно распределяет между учениками
   - Устанавливает флаг `is_assigned = True`
   - Записывает `student_id` и `assigned_at`

2. **Резервные коды для 8 класса**:
   - Берет нераспределенные коды 9 класса
   - Распределяет между параллелями 8 класса (8А, 8Б и т.д.)
   - Количество резервных кодов = количество учеников в параллели

3. **Экспорт файлов**:
   - Создает отдельный Excel файл для каждой параллели
   - Формат имени: `8А.xlsx`, `11И.xlsx` и т.д.
   - Содержимое:
     - Основная таблица: ФИО - Код
     - Для 8 класса: дополнительный лист "Резервные коды"

#### Пример вывода:

```
🚀 Начинаем распределение кодов для сессии 1
================================================================================
📚 Олимпиада: Математика
📅 Дата: 2025-10-15

👥 Найдено учеников:
   5 класс: 25 чел.
   6 класс: 30 чел.
   7 класс: 28 чел.
   8 класс: 45 чел.
   9 класс: 40 чел.
   10 класс: 35 чел.
   11 класс: 32 чел.

📊 Обрабатываем 5 класс...
   ✅ Распределено: 25/25
📊 Обрабатываем 6 класс...
   ✅ Распределено: 30/30
...

🔄 Выделяем резервные коды 9 класса для 8 класса...
   📦 Доступно кодов 9 класса: 50
   ✅ 8А: выделено 15 резервных кодов
   ✅ 8Б: выделено 15 резервных кодов
   ✅ 8В: выделено 15 резервных кодов
   📊 Всего выделено резервных кодов: 45

================================================================================
📈 ИТОГОВАЯ СТАТИСТИКА
================================================================================

5 класс:
  👥 Учеников: 25
  ✅ Распределено кодов: 25
  📦 Осталось кодов: 0

8 класс:
  👥 Учеников: 45
  ✅ Распределено кодов: 45
  📦 Осталось кодов: 0
  🔄 Резервных кодов (из 9 кл.): 45

...

📁 Экспортируем файлы в директорию: exports
================================================================================
   ✅ Создан: 5А.xlsx (12 учеников)
   ✅ Создан: 5Б.xlsx (13 учеников)
   ...
   ✅ Создан: 8А.xlsx (15 учеников)
   ✅ Создан: 8Б.xlsx (15 учеников)
   ...

✅ Экспорт завершен! Файлы находятся в: exports
```

#### Структура Excel файлов:

**Для всех классов (кроме 8):**
```
╔══════════════════════════════╦═══════════════════════════╗
║ Олимпиада: Математика | Класс: 11А                    ║
║ Дата: 15.10.2025                                       ║
╠══════════════════════════════╬═══════════════════════════╣
║ ФИО                          ║ Код                       ║
╠══════════════════════════════╬═══════════════════════════╣
║ Иванов Иван Иванович         ║ sbli58/sch771584/11/abc123║
║ Петров Петр Петрович         ║ sbli58/sch771584/11/def456║
║ ...                          ║ ...                       ║
╚══════════════════════════════╩═══════════════════════════╝
```

**Для 8 класса (два листа):**

Лист 1: "8А"
```
╔══════════════════════════════╦═══════════════════════════╗
║ Олимпиада: Математика | Класс: 8А                     ║
║ Дата: 15.10.2025                                       ║
╠══════════════════════════════╬═══════════════════════════╣
║ ФИО                          ║ Код                       ║
╠══════════════════════════════╬═══════════════════════════╣
║ Сидоров Сидор Сидорович      ║ sbli58/sch771584/8/xyz789 ║
║ ...                          ║ ...                       ║
╚══════════════════════════════╩═══════════════════════════╝
```

Лист 2: "Резервные коды"
```
╔═══════════════════════════════════════════════════════╗
║ Резервные коды (из пула 9 класса)                    ║
║ Эти коды выдаются по запросу любому ученику класса   ║
╠═════╦═════════════════════════════════════════════════╣
║ №   ║ Код                                             ║
╠═════╬═════════════════════════════════════════════════╣
║ 1   ║ sbli58/sch771584/9/aaa111                       ║
║ 2   ║ sbli58/sch771584/9/bbb222                       ║
║ 3   ║ sbli58/sch771584/9/ccc333                       ║
║ ... ║ ...                                             ║
╚═════╩═════════════════════════════════════════════════╝
```

---

### Вариант 2: Выдача кодов по запросу (через бота)

**Этот функционал требует дополнительной реализации в боте.**

Основная логика должна быть:

1. Ученик регистрируется в боте (указывает класс)
2. Ученик запрашивает код через команду `/get_code`
3. Бот проверяет класс ученика
4. Бот ищет доступные коды для этого класса:
   - `is_assigned = False` (не распределены) ИЛИ
   - `is_assigned = True` AND `student_id = current_student_id` (уже его код)
5. Выдает код и устанавливает `is_issued = True`
6. Для 8 класса: если основной код закончился, выдает из резервных

---

## 📊 Структура базы данных

### Таблица: `olympiad_codes`

Универсальная таблица для кодов всех классов (5-11).

```sql
CREATE TABLE olympiad_codes (
    id SERIAL PRIMARY KEY,
    session_id INTEGER NOT NULL,          -- FK к olympiad_sessions
    class_number INTEGER NOT NULL,        -- 5-11
    code VARCHAR(100) NOT NULL,

    -- Вариант 1: Предварительное распределение
    student_id INTEGER,                   -- FK к students (может быть NULL)
    is_assigned BOOLEAN DEFAULT FALSE,    -- Распределен ли код
    assigned_at TIMESTAMP,

    -- Вариант 2: Выдача по запросу
    is_issued BOOLEAN DEFAULT FALSE,      -- Выдан ли код ученику
    issued_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW()
);
```

**Состояния кода:**

| is_assigned | is_issued | student_id | Описание |
|-------------|-----------|------------|----------|
| FALSE | FALSE | NULL | Код свободен, не распределен |
| TRUE | FALSE | 123 | Код распределен ученику, но еще не выдан |
| TRUE | TRUE | 123 | Код распределен и выдан ученику |
| FALSE | TRUE | 123 | Код не был распределен, но выдан по запросу |

### Таблица: `grade8_reserve_codes`

Резервные коды из пула 9 класса для 8-классников.

```sql
CREATE TABLE grade8_reserve_codes (
    id SERIAL PRIMARY KEY,
    session_id INTEGER NOT NULL,          -- FK к olympiad_sessions
    class_parallel VARCHAR(10) NOT NULL,  -- "8А", "8Б", "8В" и т.д.
    code VARCHAR(100) NOT NULL,

    is_used BOOLEAN DEFAULT FALSE,
    used_by_student_id INTEGER,           -- FK к students
    used_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🔄 Миграция со старой системы

### Что происходит с данными:

1. **grade8_codes** → **olympiad_codes**
   - Все коды переносятся с `class_number = 8`
   - `is_issued` копируется как есть
   - `student_id` сохраняется

2. **grade9_codes** → **olympiad_codes**
   - Все коды переносятся с `class_number = 9`
   - `is_used` становится `is_issued`
   - `assigned_student_id` становится `student_id`

3. Старые таблицы можно удалить после проверки:

```sql
-- После проверки что все данные мигрировали:
DROP TABLE IF EXISTS grade8_codes CASCADE;
DROP TABLE IF EXISTS grade9_codes CASCADE;
```

---

## 📝 Примеры использования

### Пример 1: Распределить коды для новой олимпиады

```bash
# 1. Загрузите коды через админ-панель (таб "Коды")
#    Будет создана новая сессия олимпиады, например ID=5

# 2. Запустите скрипт распределения
python scripts/distribute_codes.py --session-id 5

# 3. Раздайте файлы учителям
#    Файлы находятся в директории exports/
#    8А.xlsx -> учителю 8А класса
#    11И.xlsx -> учителю 11И класса
#    и т.д.
```

### Пример 2: Перераспределить коды

```bash
# 1. Сбросить распределение в БД
psql -U postgres olympus_bot << EOF
UPDATE olympiad_codes
SET is_assigned = FALSE, student_id = NULL, assigned_at = NULL
WHERE session_id = 5;

DELETE FROM grade8_reserve_codes WHERE session_id = 5;
EOF

# 2. Запустить скрипт заново
python scripts/distribute_codes.py --session-id 5
```

### Пример 3: Только экспорт (без перераспределения)

Если коды уже распределены и нужно только пересоздать файлы:

```python
# Создайте простой скрипт export_only.py:
import asyncio
from scripts.distribute_codes import ExcelExporter
from database.database import get_async_session

async def main():
    async for session in get_async_session():
        exporter = ExcelExporter(session, session_id=5, output_dir="new_exports")
        await exporter.export_all()
        await session.close()

asyncio.run(main())
```

---

## 🧪 Тестирование

### Проверка миграции:

```sql
-- Проверить что таблицы созданы
\d olympiad_codes
\d grade8_reserve_codes

-- Проверить что данные мигрировали
SELECT class_number, COUNT(*) FROM olympiad_codes GROUP BY class_number;

-- Проверить резервные коды 8 класса
SELECT class_parallel, COUNT(*) FROM grade8_reserve_codes GROUP BY class_parallel;
```

### Тестирование скрипта:

```bash
# Тест на тестовой сессии
python scripts/distribute_codes.py --session-id 999 --output-dir test_exports/

# Проверка экспорта
ls -lh test_exports/
# Должны быть файлы: 5А.xlsx, 8Б.xlsx, 11И.xlsx и т.д.
```

---

## ⚠️ Важные замечания

### 1. Резервные коды для 8 класса

- Резервные коды берутся **только из нераспределенных** кодов 9 класса
- Если все коды 9 класса распределены 9-классникам, резервных кодов не будет
- Рекомендуется загружать избыточное количество кодов 9 класса

### 2. Количество кодов

Убедитесь что загружено достаточно кодов:
- Для каждого класса: минимум = количество учеников
- Для 9 класса: количество 9-классников + количество 8-классников (для резерва)

### 3. Порядок операций

Правильный порядок:
1. Загрузить учеников через Excel
2. Загрузить коды через CSV
3. Запустить скрипт распределения
4. Раздать файлы учителям

### 4. Backup

Всегда делайте backup перед миграцией:
```bash
pg_dump -U postgres olympus_bot > backup_$(date +%Y%m%d_%H%M%S).sql
```

---

## 🆘 Troubleshooting

### Ошибка: "Недостаточно кодов"

```
⚠️  Недостаточно кодов! Нужно: 30, Доступно: 25
```

**Решение:** Загрузите больше кодов для этого класса через админ-панель.

### Ошибка: "Нет доступных кодов 9 класса для резерва"

```
⚠️  Нет доступных кодов 9 класса для резерва
```

**Решение:** Все коды 9 класса распределены. Загрузите больше кодов 9 класса или уменьшите количество распределяемых кодов.

### Файлы не создаются

**Проверьте:**
1. Права на запись в директорию `exports/`
2. Установлен ли `openpyxl`: `pip install openpyxl`
3. Запущен ли скрипт с флагом `--skip-export`

---

## 📈 Дальнейшее развитие

### TODO:

- [ ] Реализовать Вариант 2 (выдача по запросу) в Telegram боте
- [ ] Добавить API эндпоинт для распределения кодов
- [ ] Добавить веб-интерфейс для запуска скрипта
- [ ] Добавить email рассылку файлов учителям
- [ ] Статистика использования кодов в реальном времени
- [ ] История перераспределений

---

## 📞 Поддержка

При возникновении проблем:
1. Проверьте логи: `logs/bot.log`
2. Проверьте БД: `psql -U postgres olympus_bot`
3. Проверьте миграцию: см. раздел "Тестирование"

---

**Версия системы:** 3.0 (Universal Codes)
**Дата создания:** Октябрь 2025
**Статус:** ✅ Ready for testing
