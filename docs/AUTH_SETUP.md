# Настройка системы авторизации Olympus Bot

## Обзор

Система авторизации Olympus Bot использует Telegram бота для аутентификации пользователей веб-панели. Это обеспечивает безопасный доступ через QR-код или deep link.

## Архитектура

```
┌──────────┐      1. Запрос QR    ┌──────────┐
│  Браузер │ ──────────────────> │   API    │
│          │                      │          │
│  /login  │ <─────────────────  │  /auth   │
└──────────┘    2. QR-код/ссылка  └──────────┘
      │                                 │
      │ 3. Сканирует QR                │
      ↓                                 │
┌──────────┐    4. Подтверждение  ┌─────────┐
│ Telegram │ ───────────────────> │   Bot   │
│   Бот    │                      │         │
└──────────┘                      └─────────┘
      │                                 │
      │ 5. Создание сессии             │
      ↓                                 ↓
┌──────────────────────────────────────────┐
│           PostgreSQL Database            │
│  users | auth_tokens | sessions         │
└──────────────────────────────────────────┘
```

## Установка и настройка

### 1. Переменные окружения (.env)

Добавьте следующие переменные в файл `.env`:

```bash
# API URL для обращения бота к API
API_URL=http://localhost:8001

# Включение защиты API (установите true для продакшена)
ENABLE_API_AUTH=false

# Имя вашего Telegram бота (без @)
BOT_USERNAME=OlympusCodeGenBot
```

### 2. Миграция базы данных

Система автоматически создает необходимые таблицы:

```bash
# Миграция уже применена
./venv/bin/alembic upgrade head
```

Созданные таблицы:
- `users` - Пользователи системы
- `auth_tokens` - Временные токены авторизации (срок жизни: 15 минут)
- `sessions` - Активные сессии пользователей (срок жизни: 7 дней)

### 3. Добавление первого администратора

Используйте команду бота для добавления пользователя:

```
/adduser
```

1. Отправьте команду `/adduser` боту от имени администратора
2. Введите ваш Telegram ID
3. Выберите роль: `admin`

**Узнать свой Telegram ID:** [@userinfobot](https://t.me/userinfobot)

## Использование

### Для пользователей

#### Вход в систему:

1. Откройте веб-панель: `http://localhost:8001/`
2. Вас перенаправит на страницу `/login`
3. Введите ваш Telegram ID
4. Нажмите "Получить QR-код"
5. Отсканируйте QR-код или нажмите кнопку "Открыть в Telegram"
6. Подтвердите вход в боте
7. Браузер автоматически перенаправит вас в панель управления

#### Выход из системы:

В панели управления нажмите кнопку "Выход" или используйте:
```
GET /api/auth/logout
```

### Для администраторов

#### Команды бота:

```bash
/adduser              # Добавить нового пользователя
/listusers           # Список всех пользователей
/deluser <telegram_id>    # Удалить пользователя
/setactive <telegram_id> <true/false>  # Активировать/деактивировать
```

#### Пример использования:

```
# Добавить пользователя
/adduser
> 123456789
> admin

# Список пользователей
/listusers

# Деактивировать пользователя
/setactive 123456789 false

# Удалить пользователя
/deluser 123456789
```

## API Endpoints

### Публичные (не требуют авторизации):

- `GET /login` - Страница входа
- `POST /api/auth/request-login` - Запрос токена авторизации
- `POST /api/auth/verify` - Подтверждение токена
- `GET /api/auth/check` - Проверка статуса авторизации

### Защищенные (требуют авторизации):

- `GET /` - Главная панель управления
- `GET /api/auth/me` - Информация о текущем пользователе
- `POST /api/auth/logout` - Выход из системы
- Все остальные API endpoints (когда `ENABLE_API_AUTH=true`)

## Роли пользователей

### admin
- Полный доступ ко всем функциям
- Управление пользователями
- Управление олимпиадами
- Просмотр всех данных

### teacher
- Управление олимпиадами
- Просмотр данных учеников
- Экспорт отчетов

### viewer
- Только просмотр данных
- Без возможности изменений

## Безопасность

### Токены авторизации:
- Генерируются криптографически безопасно (`secrets.token_urlsafe`)
- Одноразовые (cannot be reused)
- Срок жизни: 15 минут
- Автоматически удаляются после использования

### Сессии:
- Хранятся в cookie `session_token`
- HttpOnly (защита от XSS)
- Срок жизни: 7 дней
- Автоматическое продление при активности
- Привязка к IP и User-Agent (опционально)

### Middleware:
- Проверка на каждом запросе
- Автоматическое обновление времени последней активности
- Логирование критических операций

## Тестирование

### 1. Проверка API авторизации:

```bash
# Проверка статуса (без авторизации)
curl http://localhost:8001/api/auth/check

# Должен вернуть: {"authenticated": false}
```

### 2. Проверка страницы входа:

```bash
# Открыть в браузере
http://localhost:8001/login
```

### 3. Полный цикл авторизации:

1. Добавьте пользователя через бота: `/adduser`
2. Откройте `/login` в браузере
3. Введите Telegram ID
4. Отсканируйте QR-код
5. Подтвердите в боте
6. Проверьте перенаправление на главную страницу

### 4. Проверка защиты API:

```bash
# Установите в .env
ENABLE_API_AUTH=true

# Перезапустите API
./venv/bin/uvicorn api.main:app --host 0.0.0.0 --port 8001 --reload

# Попытка доступа без авторизации
curl http://localhost:8001/api/students/
# Должен вернуть: {"detail": "Требуется авторизация"}

# После авторизации в браузере cookie будет установлен автоматически
```

## Troubleshooting

### Проблема: QR-код не генерируется

**Решение:**
- Проверьте, что API запущен
- Проверьте, что пользователь существует в БД
- Проверьте логи API

### Проблема: Бот не отвечает на deep link

**Решение:**
- Убедитесь, что роутер `auth` зарегистрирован первым
- Проверьте, что `CommandStart(deep_link=True)` работает
- Проверьте логи бота

### Проблема: Сессия не сохраняется

**Решение:**
- Проверьте, что cookies включены в браузере
- Убедитесь, что используется HTTPS в продакшене
- Проверьте настройки `SameSite` для cookies

### Проблема: API_URL недоступен из бота

**Решение:**
- Если бот и API на разных серверах, используйте публичный URL
- Проверьте firewall и сетевые настройки
- Для локальной разработки используйте `http://localhost:8001`

## Миграция на продакшен

### 1. Обновите .env:

```bash
# Используйте публичные URL
API_URL=https://your-domain.com
BOT_USERNAME=YourProductionBot

# Включите защиту API
ENABLE_API_AUTH=true

# Используйте HTTPS
# Настройте SSL сертификаты
```

### 2. Настройте HTTPS:

```bash
# Используйте nginx или другой reverse proxy
# Пример конфигурации nginx:

server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. Настройте базу данных:

```bash
# Используйте продакшен БД
DATABASE_URL=postgresql+asyncpg://user:pass@prod-host:5432/olympus_bot
```

## Дополнительные функции

### Автоматическое удаление истекших токенов:

Добавьте cron задачу:

```sql
-- Очистка истекших токенов (запускать раз в час)
DELETE FROM auth_tokens WHERE expires_at < NOW();

-- Очистка истекших сессий
DELETE FROM sessions WHERE expires_at < NOW();
```

### Уведомления о новых входах:

Можно добавить уведомление администратору при каждом новом входе в систему (опционально).

## Справка

### Полезные ссылки:
- [ARCHITECTURE_AUTH.md](./ARCHITECTURE_AUTH.md) - Подробная архитектура
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [aiogram Deep Links](https://docs.aiogram.dev/en/latest/dispatcher/filters/command.html)

### Поддержка:
- Telegram: @your_support_channel
- GitHub Issues: https://github.com/your-repo/issues
